<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Traffic Signal Monitor</title>
    <style>
        :root {
            --red: #dc3545;
            --green: #28a745;
            --yellow: #ffc107;
            --blue: #007bff;
            --dark: #2a2a2a;
            --darker: #1a1a1a;
            --light: #f5f5f5;
            --intersection-bg: #404040;
            --card-bg: rgba(255,255,255,0.05);
            --border: rgba(255,255,255,0.1);
            --glow-red: rgba(220, 53, 69, 0.7);
            --glow-green: rgba(40, 167, 69, 0.7);
            --glow-yellow: rgba(255, 193, 7, 0.7);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, var(--darker) 100%);
            min-height: 100vh;
            color: var(--light);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: var(--card-bg);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            background: linear-gradient(45deg, #ffffff, #a0a0a0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.8;
        }

        .main-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        .intersection-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 40px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            position: relative;
            min-height: 700px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .intersection {
            position: relative;
            width: 600px;
            height: 600px;
        }

        .road {
            position: absolute;
            background: var(--intersection-bg);
            border: 2px solid #666;
            border-radius: 8px;
        }

        .horizontal-road {
            width: 100%;
            height: 80px;
            top: 50%;
            transform: translateY(-50%);
        }

        .vertical-road {
            width: 80px;
            height: 100%;
            left: 50%;
            transform: translateX(-50%);
        }

        .signal {
            position: absolute;
            width: 60px;
            height: 160px;
            background: #333;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            padding: 15px 0;
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            border: 2px solid #555;
            transition: all 0.3s ease;
        }

        .signal-light {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #2a2a2a;
            border: 2px solid #555;
            transition: all 0.5s ease;
            position: relative;
        }

        .signal-light::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 8px;
            background: #666;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
        }

        .signal-light.RED {
            background: var(--red);
            box-shadow: 0 0 30px var(--glow-red), inset 0 0 10px rgba(255,255,255,0.2);
            border-color: #a71e2a;
        }

        .signal-light.RED::after {
            background: rgba(255,255,255,0.8);
        }

        .signal-light.GREEN {
            background: var(--green);
            box-shadow: 0 0 30px var(--glow-green), inset 0 0 10px rgba(255,255,255,0.2);
            border-color: #1e7e34;
        }

        .signal-light.GREEN::after {
            background: rgba(255,255,255,0.8);
        }

        .signal-light.YELLOW {
            background: var(--yellow);
            box-shadow: 0 0 30px var(--glow-yellow), inset 0 0 10px rgba(255,255,255,0.2);
            border-color: #d39e00;
            animation: yellow-pulse 0.5s ease-in-out;
        }

        .signal-light.YELLOW::after {
            background: rgba(0,0,0,0.8);
        }

        @keyframes yellow-pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 30px var(--glow-yellow), inset 0 0 10px rgba(255,255,255,0.2);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 40px var(--glow-yellow), inset 0 0 15px rgba(255,255,255,0.3);
            }
        }

        .signal-1 { top: 5%; left: 5%; }
        .signal-2 { top: 5%; right: 5%; }
        .signal-3 { bottom: 5%; left: 5%; }
        .signal-4 { bottom: 5%; right: 5%; }

        .signal-label {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: bold;
            white-space: nowrap;
            border: 1px solid var(--blue);
        }

        .ped-signal {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 8px;
            background: rgba(0,0,0,0.7);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .ped-signal-1 { top: 5%; left: 80px; }
        .ped-signal-2 { top: 5%; right: 80px; }
        .ped-signal-3 { bottom: 5%; left: 80px; }
        .ped-signal-4 { bottom: 5%; right: 80px; }

        .ped-light {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            margin: 5px auto;
            border: 2px solid #666;
            transition: all 0.3s ease;
            background: #2a2a2a;
        }

        .ped-light.RED {
            background: var(--red);
            box-shadow: 0 0 15px rgba(220, 53, 69, 0.5);
        }

        .ped-light.GREEN {
            background: var(--green);
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.5);
        }

        .ped-light.YELLOW {
            background: var(--yellow);
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.5);
        }

        .ped-signal span {
            font-size: 0.8rem;
            color: var(--light);
            margin-top: 5px;
        }

        .control-panel {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            height: fit-content;
        }

        .status-section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .status-section h3 {
            color: var(--blue);
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 2px solid rgba(0,123,255,0.3);
            padding-bottom: 8px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 0;
        }

        .status-value {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .status-online {
            background: rgba(40, 167, 69, 0.2);
            color: var(--green);
            border: 1px solid var(--green);
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group h4 {
            color: var(--light);
            margin-bottom: 10px;
            font-size: 1rem;
            opacity: 0.9;
        }

        button {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(45deg, var(--blue), #0056b3);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.9rem;
            box-shadow: 0 4px 15px rgba(0,123,255,0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,123,255,0.4);
            background: linear-gradient(45deg, #0056b3, var(--blue));
        }

        button:active {
            transform: translateY(0);
        }

        button.vip {
            background: linear-gradient(45deg, #ff9500, #ff6b00);
            box-shadow: 0 4px 15px rgba(255,149,0,0.3);
        }

        button.vip:hover {
            box-shadow: 0 6px 20px rgba(255,149,0,0.4);
        }

        button.danger {
            background: linear-gradient(45deg, var(--red), #a71e2a);
            box-shadow: 0 4px 15px rgba(220,53,69,0.3);
        }

        button.danger:hover {
            box-shadow: 0 6px 20px rgba(220,53,69,0.4);
        }

        .event-log {
            max-height: 250px;
            overflow-y: auto;
            background: rgba(0,0,0,0.4);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .log-entry {
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            border-left: 4px solid;
            line-height: 1.3;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .log-normal { background: rgba(0, 123, 255, 0.1); border-left-color: var(--blue); }
        .log-vip { background: rgba(255, 149, 0, 0.1); border-left-color: #ff9500; }
        .log-error { background: rgba(220, 53, 69, 0.1); border-left-color: var(--red); }
        .log-change { background: rgba(40, 167, 69, 0.1); border-left-color: var(--green); }
        .log-ra { background: rgba(138, 43, 226, 0.1); border-left-color: #8a2be2; }
        .log-berkeley { background: rgba(255, 215, 0, 0.1); border-left-color: #ffd700; }

        .vip-indicator {
            position: absolute;
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #ffd700, #ff8c00);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            animation: vip-pulse 2s infinite;
            border: 3px solid #fff;
            font-size: 0.7rem;
            z-index: 100;
        }

        @keyframes vip-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); box-shadow: 0 0 40px rgba(255, 215, 0, 1); }
        }

        .connection-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 0.9rem;
            z-index: 1000;
            background: var(--green);
            color: white;
            box-shadow: 0 0 15px var(--glow-green);
        }

        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .intersection {
                width: 500px;
                height: 500px;
            }
        }

        @media (max-width: 768px) {
            .intersection {
                width: 400px;
                height: 400px;
            }

            .signal {
                width: 50px;
                height: 130px;
            }

            .signal-light {
                width: 28px;
                height: 28px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö¶ Enhanced Traffic Signal Monitor</h1>
            <p>Distributed System Demo - Ricart-Agrawala, Berkeley Sync, VIP Priority</p>
        </div>

        <div class="main-container">
            <div class="intersection-container">
                <div class="intersection" id="intersection">
                    <div class="road horizontal-road"></div>
                    <div class="road vertical-road"></div>

                    <div class="signal signal-1">
                        <div class="signal-label">S1 (1-2)</div>
                        <div class="signal-light" id="signal-1-red"></div>
                        <div class="signal-light" id="signal-1-yellow"></div>
                        <div class="signal-light" id="signal-1-green"></div>
                    </div>

                    <div class="signal signal-2">
                        <div class="signal-label">S2 (1-2)</div>
                        <div class="signal-light" id="signal-2-red"></div>
                        <div class="signal-light" id="signal-2-yellow"></div>
                        <div class="signal-light" id="signal-2-green"></div>
                    </div>

                    <div class="signal signal-3">
                        <div class="signal-label">S3 (3-4)</div>
                        <div class="signal-light" id="signal-3-red"></div>
                        <div class="signal-light" id="signal-3-yellow"></div>
                        <div class="signal-light" id="signal-3-green"></div>
                    </div>

                    <div class="signal signal-4">
                        <div class="signal-label">S4 (3-4)</div>
                        <div class="signal-light" id="signal-4-red"></div>
                        <div class="signal-light" id="signal-4-yellow"></div>
                        <div class="signal-light" id="signal-4-green"></div>
                    </div>

                    <div class="ped-signal ped-signal-1">
                        <div class="ped-light" id="ped-1"></div>
                        <span>P1</span>
                    </div>

                    <div class="ped-signal ped-signal-2">
                        <div class="ped-light" id="ped-2"></div>
                        <span>P2</span>
                    </div>

                    <div class="ped-signal ped-signal-3">
                        <div class="ped-light" id="ped-3"></div>
                        <span>P3</span>
                    </div>

                    <div class="ped-signal ped-signal-4">
                        <div class="ped-light" id="ped-4"></div>
                        <span>P4</span>
                    </div>
                </div>
            </div>

            <div class="control-panel">
                <div class="status-section">
                    <h3>System Status</h3>
                    <div class="status-item">
                        <span>Connection:</span>
                        <span class="status-value status-online" id="connection-status">Online (Simulated)</span>
                    </div>
                    <div class="status-item">
                        <span>Last Update:</span>
                        <span class="status-value" id="last-update">--:--:--</span>
                    </div>
                    <div class="status-item">
                        <span>Active VIPs:</span>
                        <span class="status-value" id="active-vips">0</span>
                    </div>
                    <div class="status-item">
                        <span>Controller:</span>
                        <span class="status-value" id="active-controller">CONTROLLER</span>
                    </div>
                </div>

                <div class="control-group">
                    <h4>Traffic Simulation</h4>
                    <div class="controls">
                        <button onclick="sendTrafficRequest([1,2])">Request Signals 1-2</button>
                        <button onclick="sendTrafficRequest([3,4])">Request Signals 3-4</button>
                        <button class="vip" onclick="sendVIPRequest([1,2])">VIP Request 1-2</button>
                        <button class="vip" onclick="sendVIPRequest([3,4])">VIP Request 3-4</button>
                        <button class="danger" onclick="createDeadlock()">Create Deadlock</button>
                    </div>
                </div>

                <div class="control-group">
                    <h4>System Controls</h4>
                    <div class="controls">
                        <button onclick="triggerBerkeley()">üïê Berkeley Sync</button>
                        <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
                    </div>
                </div>

                <div class="status-section">
                    <h3>Event Log</h3>
                    <div class="event-log" id="event-log">
                        <div class="log-entry log-normal">
                            <strong>[SYSTEM]</strong> Distributed traffic control initialized
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="connection-indicator">Simulated System Online</div>

    <script>
        // System state
        let currentSignals = {
            "1": "RED", "2": "RED", "3": "GREEN", "4": "GREEN",
            "P1": "GREEN", "P2": "GREEN", "P3": "RED", "P4": "RED"
        };
        let previousSignals = {...currentSignals};
        let vipQueue = {12: [], 34: []};
        let activeVIPs = 0;
        let lamportClock = 0;
        let controllers = ["CONTROLLER", "CONTROLLER_CLONE"];
        let currentController = 0;

        function log(message, type = 'normal') {
            const logContainer = document.getElementById('event-log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;

            const timestamp = new Date().toLocaleTimeString();
            entry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;

            logContainer.insertBefore(entry, logContainer.firstChild);

            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        function updateDisplay() {
            for (let i = 1; i <= 4; i++) {
                const status = currentSignals[i.toString()];

                const redEl = document.getElementById(`signal-${i}-red`);
                const yellowEl = document.getElementById(`signal-${i}-yellow`);
                const greenEl = document.getElementById(`signal-${i}-green`);

                redEl.className = 'signal-light';
                yellowEl.className = 'signal-light';
                greenEl.className = 'signal-light';

                if (status === 'RED') redEl.classList.add('RED');
                else if (status === 'YELLOW') yellowEl.classList.add('YELLOW');
                else if (status === 'GREEN') greenEl.classList.add('GREEN');
            }

            for (let i = 1; i <= 4; i++) {
                const status = currentSignals[`P${i}`];
                const pedEl = document.getElementById(`ped-${i}`);

                pedEl.className = 'ped-light';
                if (status === 'RED') pedEl.classList.add('RED');
                else if (status === 'GREEN') pedEl.classList.add('GREEN');
                else if (status === 'YELLOW') pedEl.classList.add('YELLOW');
            }

            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }

        async function simulateRicartAgrawala(targetPair, requestType, requesterInfo) {
            lamportClock++;
            const timestamp = lamportClock;

            log(`[RICART-AGRAWALA] Request for ${targetPair} (ts=${timestamp}, type=${requestType})`, 'ra');
            log(`[RA] Requesting votes from all nodes...`, 'ra');

            await sleep(300);

            log(`[RA] ‚úì Vote received from CONTROLLER (ts=${timestamp})`, 'ra');
            await sleep(200);
            log(`[RA] ‚úì Vote received from CONTROLLER_CLONE (ts=${timestamp})`, 'ra');
            await sleep(200);
            log(`[RA] ‚úì Vote received from p_signal (ts=${timestamp})`, 'ra');
            await sleep(200);

            log(`[RA] All votes collected - ENTERING CRITICAL SECTION`, 'ra');
            return true;
        }

        async function simulatePedestrianCheck(targetPair, requestType) {
            log(`[PEDESTRIAN] Requesting safety clearance for ${targetPair}`, 'normal');
            await sleep(200);

            const pedSignals = targetPair[0] <= 2 ? ['P1', 'P2'] : ['P3', 'P4'];
            const safe = pedSignals.every(p => currentSignals[p] !== 'GREEN');

            if (safe) {
                log(`[PEDESTRIAN] ‚úì Safety check PASSED - pedestrians clear`, 'change');
            } else {
                log(`[PEDESTRIAN] ‚ö† Pedestrians crossing - waiting...`, 'normal');
                await sleep(1000);
                log(`[PEDESTRIAN] ‚úì Pedestrians cleared`, 'change');
            }
            return true;
        }

        async function switchSignals(targetPair, reason) {
            const otherPair = targetPair[0] <= 2 ? [3, 4] : [1, 2];

            log(`[SIGNAL-CHANGE] Switching from ${otherPair} to ${targetPair} (${reason})`, 'change');

            // Pedestrian signals first
            log(`[PEDESTRIAN-SIGNALS] Blinking pedestrian signals for ${targetPair}`, 'normal');
            for (let sig of targetPair) {
                currentSignals[`P${sig}`] = 'RED';
            }
            updateDisplay();
            await sleep(500);

            for (let sig of otherPair) {
                currentSignals[`P${sig}`] = 'YELLOW';
            }
            updateDisplay();
            await sleep(800);

            for (let sig of otherPair) {
                currentSignals[`P${sig}`] = 'GREEN';
            }
            updateDisplay();

            // Traffic signals
            log(`[TRAFFIC-SIGNALS] Yellow transition for ${otherPair}`, 'normal');
            for (let sig of otherPair) {
                currentSignals[sig.toString()] = 'YELLOW';
            }
            updateDisplay();
            await sleep(1000);

            for (let sig of otherPair) {
                currentSignals[sig.toString()] = 'RED';
            }
            updateDisplay();
            await sleep(500);

            log(`[TRAFFIC-SIGNALS] GREEN for ${targetPair}`, 'change');
            for (let sig of targetPair) {
                currentSignals[sig.toString()] = 'GREEN';
            }
            updateDisplay();

            log(`[DATABASE] Signal status updated in ZooKeeper DB (source: ${reason})`, 'normal');
        }

        async function sendTrafficRequest(targetPair) {
            const controller = controllers[currentController];
            currentController = (currentController + 1) % controllers.length;

            document.getElementById('active-controller').textContent = controller;

            log(`[ZOOKEEPER] Load balancing: Assigned to ${controller}`, 'normal');
            log(`[${controller}] Processing normal traffic request for ${targetPair}`, 'normal');

            await simulateBerkeleyClock();

            if (vipQueue[12].length + vipQueue[34].length > 0) {
                log(`[${controller}] VIP vehicles in queue - processing VIPs first`, 'vip');
                return;
            }

            const hasRA = await simulateRicartAgrawala(targetPair, "NORMAL", "Normal Traffic");
            if (!hasRA) return;

            const hasPed = await simulatePedestrianCheck(targetPair, "NORMAL");
            if (!hasPed) return;

            log(`[CRITICAL-SECTION] ${controller} ACQUIRED intersection mutex`, 'ra');

            const currentGreen = getCurrentGreen();
            if (JSON.stringify(currentGreen) !== JSON.stringify(targetPair)) {
                await switchSignals(targetPair, `normal_traffic_${controller}`);
            } else {
                log(`[${controller}] Signals already correct for ${targetPair}`, 'normal');
            }

            await sleep(1000);
            log(`[CRITICAL-SECTION] ${controller} RELEASED intersection mutex`, 'ra');
        }

        async function sendVIPRequest(targetPair) {
            const controller = controllers[currentController];
            currentController = (currentController + 1) % controllers.length;

            const vehicleId = `VIP_${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
            const priority = Math.floor(Math.random() * 3) + 1;
            const types = {1: 'AMBULANCE', 2: 'FIRE', 3: 'POLICE'};
            const type = types[priority];

            document.getElementById('active-controller').textContent = controller;

            const pairKey = targetPair[0] <= 2 ? 12 : 34;
            vipQueue[pairKey].push({id: vehicleId, priority, targetPair, type});

            activeVIPs++;
            document.getElementById('active-vips').textContent = activeVIPs;

            log(`[VIP-ARRIVAL] ${type} ${vehicleId} (Priority ${priority}) detected at ${targetPair}`, 'vip');
            log(`[ZOOKEEPER] VIP assigned to ${controller}`, 'vip');

            showVIPIndicator(targetPair, vehicleId);

            await simulateBerkeleyClock();

            const hasRA = await simulateRicartAgrawala(targetPair, "VIP", `${type}_${vehicleId}_P${priority}`);
            if (!hasRA) return;

            const hasPed = await simulatePedestrianCheck(targetPair, "VIP");
            if (!hasPed) return;

            log(`[CRITICAL-SECTION] VIP ${vehicleId} ACQUIRED intersection mutex`, 'vip');

            const currentGreen = getCurrentGreen();
            if (JSON.stringify(currentGreen) !== JSON.stringify(targetPair)) {
                await switchSignals(targetPair, `vip_priority_${priority}_${vehicleId}`);
            }

            log(`[VIP-CROSSING] ${type} ${vehicleId} crossing intersection...`, 'vip');
            await sleep(1500);

            log(`[VIP-CROSSING] ${type} ${vehicleId} completed crossing`, 'vip');
            log(`[CRITICAL-SECTION] VIP ${vehicleId} RELEASED intersection mutex`, 'vip');

            vipQueue[pairKey] = vipQueue[pairKey].filter(v => v.id !== vehicleId);
            activeVIPs--;
            document.getElementById('active-vips').textContent = activeVIPs;

            setTimeout(() => {
                const vipEl = document.getElementById(`vip-${vehicleId}`);
                if (vipEl) vipEl.remove();
            }, 2000);
        }

        async function createDeadlock() {
            log(`[DEADLOCK-SCENARIO] Creating simultaneous VIP requests...`, 'error');

            const vip1 = {
                id: `VIP_A_${Math.random().toString(36).substr(2, 4).toUpperCase()}`,
                priority: 2,
                targetPair: [1, 2],
                type: 'FIRE'
            };

            const vip2 = {
                id: `VIP_B_${Math.random().toString(36).substr(2, 4).toUpperCase()}`,
                priority: 1,
                targetPair: [3, 4],
                type: 'AMBULANCE'
            };

            vipQueue[12].push(vip1);
            vipQueue[34].push(vip2);
            activeVIPs = 2;
            document.getElementById('active-vips').textContent = activeVIPs;

            log(`[VIP-ARRIVAL] ${vip1.type} ${vip1.id} at [1,2]`, 'vip');
            log(`[VIP-ARRIVAL] ${vip2.type} ${vip2.id} at [3,4]`, 'vip');

            showVIPIndicator([1, 2], vip1.id);
            showVIPIndicator([3, 4], vip2.id);

            await sleep(500);

            log(`[VIP-DEADLOCK] ‚ö†Ô∏è DEADLOCK DETECTED: Simultaneous VIP requests from both directions`, 'error');
            log(`[VIP-DEADLOCK] Analyzing: ${vip1.type} (P${vip1.priority}) vs ${vip2.type} (P${vip2.priority})`, 'error');

            await sleep(1000);

            const currentGreen = getCurrentGreen();
            log(`[VIP-DEADLOCK] Current green signals: ${JSON.stringify(currentGreen)}`, 'error');

            let firstVIP, secondVIP;
            if (JSON.stringify(currentGreen) === JSON.stringify([1, 2])) {
                firstVIP = vip1;
                secondVIP = vip2;
                log(`[VIP-DEADLOCK] ‚úì RESOLUTION: [1,2] already green ‚Üí ${vip1.type} goes first`, 'change');
            } else if (JSON.stringify(currentGreen) === JSON.stringify([3, 4])) {
                firstVIP = vip2;
                secondVIP = vip1;
                log(`[VIP-DEADLOCK] ‚úì RESOLUTION: [3,4] already green ‚Üí ${vip2.type} goes first`, 'change');
            } else {
                if (vip2.priority < vip1.priority) {
                    firstVIP = vip2;
                    secondVIP = vip1;
                    log(`[VIP-DEADLOCK] ‚úì RESOLUTION: ${vip2.type} has higher priority (P${vip2.priority} < P${vip1.priority})`, 'change');
                } else {
                    firstVIP = vip1;
                    secondVIP = vip2;
                    log(`[VIP-DEADLOCK] ‚úì RESOLUTION: ${vip1.type} has higher/equal priority`, 'change');
                }
            }

            await sleep(1000);

            // Process first VIP
            log(`[VIP-PROCESSING] Processing ${firstVIP.type} ${firstVIP.id} first`, 'vip');
            const controller1 = controllers[0];
            document.getElementById('active-controller').textContent = controller1;

            await simulateRicartAgrawala(firstVIP.targetPair, "VIP", `${firstVIP.type}_${firstVIP.id}`);
            await simulatePedestrianCheck(firstVIP.targetPair, "VIP");

            log(`[CRITICAL-SECTION] ${firstVIP.type} ${firstVIP.id} ACQUIRED intersection mutex`, 'vip');

            if (JSON.stringify(getCurrentGreen()) !== JSON.stringify(firstVIP.targetPair)) {
                await switchSignals(firstVIP.targetPair, `vip_deadlock_resolution_${firstVIP.id}`);
            }

            log(`[VIP-CROSSING] ${firstVIP.type} ${firstVIP.id} crossing...`, 'vip');
            await sleep(1500);
            log(`[VIP-CROSSING] ${firstVIP.type} ${firstVIP.id} completed`, 'vip');
            log(`[CRITICAL-SECTION] ${firstVIP.type} ${firstVIP.id} RELEASED intersection mutex`, 'vip');

            const firstKey = firstVIP.targetPair[0] <= 2 ? 12 : 34;
            vipQueue[firstKey] = vipQueue[firstKey].filter(v => v.id !== firstVIP.id);
            activeVIPs--;
            document.getElementById('active-vips').textContent = activeVIPs;

            setTimeout(() => {
                const vipEl = document.getElementById(`vip-${firstVIP.id}`);
                if (vipEl) vipEl.remove();
            }, 1000);

            await sleep(1000);

            // Process second VIP
            log(`[VIP-PROCESSING] Now processing ${secondVIP.type} ${secondVIP.id}`, 'vip');
            const controller2 = controllers[1];
            document.getElementById('active-controller').textContent = controller2;

            await simulateRicartAgrawala(secondVIP.targetPair, "VIP", `${secondVIP.type}_${secondVIP.id}`);
            await simulatePedestrianCheck(secondVIP.targetPair, "VIP");

            log(`[CRITICAL-SECTION] ${secondVIP.type} ${secondVIP.id} ACQUIRED intersection mutex`, 'vip');

            await switchSignals(secondVIP.targetPair, `vip_deadlock_resolution_${secondVIP.id}`);

            log(`[VIP-CROSSING] ${secondVIP.type} ${secondVIP.id} crossing...`, 'vip');
            await sleep(1500);
            log(`[VIP-CROSSING] ${secondVIP.type} ${secondVIP.id} completed`, 'vip');
            log(`[CRITICAL-SECTION] ${secondVIP.type} ${secondVIP.id} RELEASED intersection mutex`, 'vip');

            const secondKey = secondVIP.targetPair[0] <= 2 ? 12 : 34;
            vipQueue[secondKey] = vipQueue[secondKey].filter(v => v.id !== secondVIP.id);
            activeVIPs--;
            document.getElementById('active-vips').textContent = activeVIPs;

            setTimeout(() => {
                const vipEl = document.getElementById(`vip-${secondVIP.id}`);
                if (vipEl) vipEl.remove();
            }, 1000);

            log(`[VIP-DEADLOCK] ‚úì Deadlock resolved successfully`, 'change');
        }

        async function triggerBerkeley() {
            log(`[BERKELEY-SYNC] ===== 7-STEP CLOCK SYNCHRONIZATION =====`, 'berkeley');

            const timeServer = controllers[0];
            log(`[BERKELEY-STEP1] Time server: ${timeServer}`, 'berkeley');

            const serverTime = Date.now();
            log(`[BERKELEY-STEP1] Server time: ${serverTime}`, 'berkeley');

            await sleep(300);

            log(`[BERKELEY-STEP2-3] Broadcasting time to all clients...`, 'berkeley');
            await sleep(200);

            const clients = [
                {name: 'CONTROLLER', offset: Math.random() * 60 - 30},
                {name: 'CONTROLLER_CLONE', offset: Math.random() * 60 - 30},
                {name: 't_signal', offset: Math.random() * 1800 - 900},
                {name: 'p_signal', offset: Math.random() * -2700}
            ];

            for (let client of clients) {
                await sleep(150);
                log(`[BERKELEY-STEP3] ${client.name} offset: ${client.offset > 0 ? '+' : ''}${client.offset.toFixed(2)}s`, 'berkeley');
            }

            await sleep(300);

            const avgOffset = clients.reduce((sum, c) => sum + c.offset, 0) / clients.length;
            log(`[BERKELEY-STEP4] Average offset calculated: ${avgOffset > 0 ? '+' : ''}${avgOffset.toFixed(2)}s`, 'berkeley');

            const newTime = serverTime + (avgOffset * 1000);
            log(`[BERKELEY-STEP4] New synchronized time: ${newTime}`, 'berkeley');

            await sleep(300);

            log(`[BERKELEY-STEP5-7] Synchronizing all clients...`, 'berkeley');

            for (let client of clients) {
                await sleep(150);
                log(`[BERKELEY-STEP7] ${client.name} synchronized successfully`, 'berkeley');
            }

            await sleep(200);
            log(`[BERKELEY-SYNC] ‚úì 7-step synchronization COMPLETED`, 'berkeley');
        }

        async function simulateBerkeleyClock() {
            if (Math.random() < 0.3) {
                log(`[BERKELEY] Quick clock sync cycle`, 'berkeley');
                await sleep(100);
            }
        }

        function showVIPIndicator(targetPair, vehicleId) {
            const vipEl = document.createElement('div');
            vipEl.className = 'vip-indicator';
            vipEl.textContent = 'VIP';
            vipEl.id = `vip-${vehicleId}`;

            if (targetPair[0] <= 2) {
                vipEl.style.top = '15%';
                vipEl.style.left = '15%';
            } else {
                vipEl.style.bottom = '15%';
                vipEl.style.right = '15%';
            }

            document.getElementById('intersection').appendChild(vipEl);
        }

        function getCurrentGreen() {
            if (currentSignals['3'] === 'GREEN' && currentSignals['4'] === 'GREEN') {
                return [3, 4];
            }
            return [1, 2];
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function clearLogs() {
            const logContainer = document.getElementById('event-log');
            logContainer.innerHTML = `
                <div class="log-entry log-normal">
                    <strong>[SYSTEM]</strong> Event log cleared
                </div>
            `;
        }

        // Initialize display
        updateDisplay();

        // Simulate periodic updates
        setInterval(() => {
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }, 1000);

        // Welcome message
        setTimeout(() => {
            log('[SYSTEM] Distributed system features:', 'normal');
            log('‚Ä¢ Ricart-Agrawala mutual exclusion', 'ra');
            log('‚Ä¢ Berkeley 7-step clock synchronization', 'berkeley');
            log('‚Ä¢ VIP priority with deadlock resolution', 'vip');
            log('‚Ä¢ Load balancing across controllers', 'normal');
            log('‚Ä¢ Pedestrian safety coordination', 'normal');
        }, 500);
    </script>
</body>
</html>